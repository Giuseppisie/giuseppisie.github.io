<script>
  // Collect feature data from the page
  const featureCards = Array.from(document.querySelectorAll('.feature-card'));
  const features = featureCards.map(card => {
    const title = card.querySelector('.feature-title')?.textContent?.trim() || '';
    const excerpt = card.querySelector('.feature-excerpt')?.textContent?.trim() || '';
    const body = card.querySelector('.feature-body');
    // prefer explicit data-full (high-res or media); fall back to first image/video src inside body
    let fullSrc = body?.getAttribute('data-full') || '';
    if (!fullSrc) {
      const img = body?.querySelector('img');
      const vid = body?.querySelector('video source');
      if (img) fullSrc = img.src || img.getAttribute('src') || '';
      else if (vid) fullSrc = vid.getAttribute('src') || '';
    }

    const paragraphs = Array.from(body?.querySelectorAll('.feature-text p') || [])
                           .map(p => p.textContent.trim())
                           .filter(t => t.length > 0);

    const listItems = Array.from(body?.querySelectorAll('.feature-text ul li') || [])
                           .map(li => li.textContent.trim())
                           .filter(t => t.length > 0);

    return { title, excerpt, fullSrc, paragraphs, listItems };
  });

  // Modal elements
  const modalOverlay = document.getElementById('featureModal');
  const modalTitle = document.getElementById('modal-title');
  const modalImg = document.getElementById('modalImg');
  const modalDesc = document.getElementById('modalDesc');
  const modalList = document.getElementById('modalList');
  const btnClose = modalOverlay.querySelector('.modal-close');
  const btnPrev = modalOverlay.querySelector('.modal-prev');
  const btnNext = modalOverlay.querySelector('.modal-next');

  let currentIndex = 0;

  function renderMedia(fullSrc, title) {
    // keep it simple: if it's a video, show a video element; otherwise use the existing <img id="modalImg">
    const isVideo = /\.(mp4|webm|ogg)$/i.test(fullSrc);
    if (isVideo) {
      // create <video> element and replace modalImg with it
      const video = document.createElement('video');
      video.setAttribute('controls', '');
      video.setAttribute('playsinline', '');
      video.className = 'modal-img';
      video.style.width = '100%';
      video.style.height = '100%';
      video.alt = title;
      // remove any existing media node inside modal-body (modalImg might be present)
      const existing = document.querySelector('.modal-body').querySelector('.modal-img');
      if (existing) existing.remove();
      const source = document.createElement('source');
      source.src = fullSrc;
      source.type = 'video/mp4';
      video.appendChild(source);
      document.querySelector('.modal-body').insertBefore(video, document.querySelector('.modal-text'));
      return;
    } else {
      // ensure no leftover <video> nodes
      const existingVideo = document.querySelector('.modal-body').querySelector('video.modal-img');
      if (existingVideo) existingVideo.remove();
      // make sure modalImg exists in DOM (it should) and set src
      if (!modalImg.parentElement) {
        // if modalImg was removed, recreate it
        const img = document.createElement('img');
        img.id = 'modalImg';
        img.className = 'modal-img';
        document.querySelector('.modal-body').insertBefore(img, document.querySelector('.modal-text'));
      }
      modalImg.src = fullSrc || '';
      modalImg.alt = title || '';
    }
  }

  function openModal(index) {
    if (index < 0 || index >= features.length) return;
    currentIndex = index;
    const f = features[index];

    modalTitle.textContent = f.title || 'Feature';
    // render media (image or video)
    renderMedia(f.fullSrc || '', f.title);

    // populate paragraphs (supports multiple <p>)
    modalDesc.innerHTML = '';
    if (f.paragraphs && f.paragraphs.length) {
      f.paragraphs.forEach(text => {
        const p = document.createElement('p');
        p.textContent = text;
        modalDesc.appendChild(p);
      });
    } else {
      // fallback to excerpt
      modalDesc.textContent = f.excerpt || '';
    }

    // populate list
    modalList.innerHTML = '';
    if (f.listItems && f.listItems.length) {
      f.listItems.forEach(li => {
        const el = document.createElement('li');
        el.textContent = li;
        modalList.appendChild(el);
      });
    }

    modalOverlay.classList.add('open');
    modalOverlay.setAttribute('aria-hidden', 'false');
    // trap focus to close button for simplicity
    btnClose.focus();
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalOverlay.classList.remove('open');
    modalOverlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    // remove any video element to stop playback
    const video = document.querySelector('.modal-body video');
    if (video) {
      video.pause();
      video.remove();
    }
    // ensure modalImg exists for next open
    if (!document.querySelector('.modal-body img.modal-img')) {
      const img = document.createElement('img');
      img.id = 'modalImg';
      img.className = 'modal-img';
      document.querySelector('.modal-body').insertBefore(img, document.querySelector('.modal-text'));
    }
  }

  function showPrev() { openModal((currentIndex - 1 + features.length) % features.length); }
  function showNext() { openModal((currentIndex + 1) % features.length); }

  // Attach click handlers to feature summaries
  featureCards.forEach((card, idx) => {
    const summary = card.querySelector('.feature-summary');
    // allow click to open modal
    summary.addEventListener('click', (e) => {
      // allow clicks on links inside summary to work normally
      if (e.target.closest('a')) return;
      e.preventDefault();
      openModal(idx);
    });

    // keyboard accessibility
    summary.setAttribute('tabindex', '0');
    summary.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openModal(idx);
      }
    });
  });

  // Modal controls
  btnClose.addEventListener('click', closeModal);
  btnPrev.addEventListener('click', (e) => { e.stopPropagation(); showPrev(); });
  btnNext.addEventListener('click', (e) => { e.stopPropagation(); showNext(); });

  // click outside modal to close
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) closeModal();
  });

  // keyboard handlers
  document.addEventListener('keydown', (e) => {
    if (!modalOverlay.classList.contains('open')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') showPrev();
    if (e.key === 'ArrowRight') showNext();
  });

  // pre-load images for smoother transitions (optional)
  features.forEach(f => {
    if (f.fullSrc && !/\.(mp4|webm|ogg)$/i.test(f.fullSrc)) {
      const img = new Image();
      img.src = f.fullSrc;
    }
  });
</script>

