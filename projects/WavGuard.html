e<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WavGuard — Smart Wakeboard</title>

  <style>
    :root {
      --bg: #a0c0bc;
      --card: #427b76;
      --accent: #b0ab52;
      --content-max: 1100px;
      --demo-side-margin: 0.5in;
      --demo-video-w: 360px;
      --demo-video-h: 640px;
      --gap: 28px;
    }

    html,body { height:100%; margin:0; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: var(--bg);
      color: #111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* TOPBAR */
    .topbar {
      position: fixed; inset: 0 0 auto 0; height:60px;
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 20px; z-index:1000;
      background: rgba(0,0,0,0.22); backdrop-filter: blur(4px);
    }
    .brand { color:#fff; font-weight:800; font-size:18px; text-shadow:0 2px 8px rgba(0,0,0,0.4); }
    .topbar a { color:#fff; text-decoration:none; font-weight:700; background:var(--card); padding:8px 12px; border-radius:8px; }

    .spacer { height:60px; }

    /* HERO */
    .hero {
      position: relative; height: 100vh; width:100%;
      background-image: url("../images/wavguard/wavguardfull.png");
      background-size: cover; background-position:center; display:flex;
      align-items:center; justify-content:center;
    }
    .hero::after { content:""; position:absolute; inset:0; background: rgba(66,123,118,0.35); }
    .hero-title { position:relative; z-index:1; color:#fff; font-size:clamp(28px,5vw,48px); font-weight:800; text-shadow:0 8px 24px rgba(0,0,0,0.6); padding:0 20px; text-align:center; }

    /* MAIN CONTENT (centered area) */
    .content { padding: 40px 20px 32px; max-width: var(--content-max); margin: 0 auto; }

    /* Intro box (centered, constrained) */
    .project-intro {
      background: #ffffff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      margin: 0 auto 28px;
      max-width: 900px;
    }
    .project-intro p {
      font-size: 17px;
      line-height: 1.7;
      color: #333;
      margin: 0 0 18px 0;
    }
    .project-intro p:last-child { margin-bottom: 0; }

    /* DEMO card centered */
    .demo-wrapper { display:flex; justify-content:center; padding-bottom: 24px; }
    .demo-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      padding: 28px;
      width: calc(100% - (var(--demo-side-margin) * 2));
      max-width: var(--content-max);
      box-sizing: border-box;
      margin: 0 auto;
    }
    .demo-card h2 { margin: 0 0 16px 0; font-size:22px; font-weight:700; color:#111; }
    .demo-grid { display:flex; gap: var(--gap); align-items:flex-start; }
    .video-col { flex: 0 0 var(--demo-video-w); width: var(--demo-video-w); height: var(--demo-video-h); display:flex; align-items:stretch; }
    .project-video { width:100%; height:100%; border-radius:10px; background:#000; object-fit:cover; display:block; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    .text-col { flex:1; font-size:17px; line-height:1.6; color:#333; }

    /* FEATURES - 3x grid */
    .features {
      margin: 28px auto 60px;
      max-width: var(--content-max,1100px);
      padding: 0 20px;
    }
    .features-heading { font-size: 28px; color: #111; margin: 0 0 16px 0; }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 22px;
    }

    .feature-card {
      background: var(--card);
      color: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      text-decoration: none;
      transition: transform .18s ease, box-shadow .18s ease;
      display: block;
      cursor: pointer;
    }
    .feature-card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0,0,0,0.18); }

    .feature-summary { display:block; padding:0; cursor:pointer; }
    .feature-thumb {
      width: 100%;
      height: 170px;
      object-fit: contain;      /* show whole image, not cropped */
      background: rgba(255,255,255,0.06);
      padding: 10px;
      display:block;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .feature-meta { padding: 14px 16px 18px 16px; display:flex; flex-direction:column; gap:8px; }
    .feature-title { font-weight:700; font-size:18px; color:#fff; }
    .feature-excerpt { font-size:14px; color: rgba(255,255,255,0.9); line-height:1.35; margin:0; }

    /* hide inline expanded body (we'll use modal for full-screen) */
    .feature-body { display: none !important; }

    @media (max-width: 1024px) { .features-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 720px) { .features-grid { grid-template-columns: 1fr; } .feature-thumb { height: 44vw; } }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: none; align-items:center; justify-content:center; z-index:2000; padding:28px;
    }
    .modal-overlay.open { display:flex; }
    .modal {
      background: #fff; width:100%; max-width:1100px; max-height:92vh;
      border-radius:12px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 30px 80px rgba(0,0,0,0.45);
    }
    .modal-top { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid rgba(0,0,0,0.06); background: linear-gradient(90deg, rgba(66,123,118,1), rgba(86,153,140,1)); color:#fff; }
    .modal-title { font-size:20px; font-weight:800; }
    .modal-close, .modal-prev, .modal-next { background: rgba(255,255,255,0.12); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
    .modal-controls { display:flex; gap:8px; align-items:center; }

    .modal-body { display:flex; gap:20px; padding:20px; overflow:auto; background:#fff; }
    .modal-img { flex: 0 0 460px; max-width:52%; border-radius:8px; object-fit:cover; box-shadow:0 10px 30px rgba(0,0,0,0.18); }
    .modal-text { flex:1; color:#111; font-size:16px; line-height:1.6; }
    .modal-text ul { margin-top:12px; padding-left:20px; }

    @media (max-width:900px) {
      .modal { max-width: calc(100% - 40px); }
      .modal-body { flex-direction: column; }
      .modal-img { max-width:100%; width:100%; height:auto; flex:none; }
    }

    .modal-close:focus, .modal-prev:focus, .modal-next:focus { outline: 3px solid rgba(176,171,82,0.35); outline-offset: 2px; }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">Sienna Giuseppi</div>
    <a href="../index.html#engineering-projects">Back to projects</a>
  </div>
  <div class="spacer"></div>

  <!-- HERO -->
  <section class="hero" aria-label="Project hero image">
    <div class="hero-title">WavGuard — Smart Wakeboard</div>
  </section>

  <!-- MAIN: intro -->
  <main class="content" aria-labelledby="project-intro-heading">
    <section class="project-intro" id="project-intro">
      <p>
        WavGuard was developed to address one of the most challenging aspects of learning to wakeboard: understanding balance on an unstable, moving surface. For beginners, progress is largely driven by trial and error—while coaches can offer guidance, riders must ultimately learn how their feet distribute pressure across the board in real time. Our team set out to reduce this learning curve by providing immediate, intuitive feedback that helps riders recognize and correct their balance as they ride.
      </p>

      <p>
        Designed by a team of five engineers, WavGuard is a smart wakeboard system that delivers live visual feedback through integrated LED indicators. The board uses a combination of force-sensitive resistors (FSRs) to measure pressure distribution and an inertial measurement unit (IMU) to track orientation and motion, allowing the system to verify and contextualize rider input. All electronic components are fully padded and embedded for comfort and safety, creating a responsive training tool that supports beginners as they build confidence, balance, and technique while riding on the water.
      </p>
    </section>
  </main>

  <!-- DEMO -->
  <section class="demo-wrapper" aria-labelledby="project-demo-heading">
    <div class="demo-card" role="region" aria-label="Project demo card">
      <h2 id="project-demo-heading">Project Demo</h2>

      <div class="demo-grid">
        <!-- VIDEO column (portrait) -->
        <div class="video-col">
          <video class="project-video" controls preload="metadata" poster="../images/wavguard/wavdemo.jpeg" playsinline>
            <source src="../images/wavguard/wavdemovid.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>

        <!-- TEXT column -->
    <div class="text-col">
    
      <p><strong>Demo overview</strong></p>
      <p>
        This demo video was recorded during our final project presentation and shows
        WavGuard operating in real time. The system uses <strong>ratio-based logic</strong>,
        comparing relationships between sensors rather than absolute force values so it
        adapts to riders of different weights and stances.
      </p>
    
      <p><strong>LED feedback system</strong></p>
      <ul>
        <li><strong>Blue:</strong> not enough pressure in a region</li>
        <li><strong>Red:</strong> too much pressure in a region</li>
        <li><strong>Green:</strong> appears only when the board is fully balanced</li>
      </ul>
      <p>
        Pressure is evaluated across toes vs. heels, left vs. right, and diagonal corners.
        Balanced regions remain unlit to avoid distracting the rider.
      </p>
    
      <p><strong>Tilt-based interpretation</strong></p>
      <p>
        Board orientation is measured using an <strong>IMU</strong>. Expected pressure
        distributions are calculated from tilt angle using <strong>linear interpolation</strong>,
        allowing feedback to adjust naturally as the board angle changes.
      </p>
    
      <p>
        The system is designed as <strong>guidance rather than a strict target</strong>,
        recognizing that some riding maneuvers naturally require imbalance.
      </p>
    
      <div class="demo-note">
        Further technical breakdowns are available in the feature sections below
        (Foot Sensors, IMU Sensor, and Code Logic).
      </div>
    
    </div>

      </div>
    </div>
  </section>

  <!-- FEATURES -->
  <section class="features" aria-labelledby="features-heading">
    <h2 id="features-heading" class="features-heading">Features</h2>

    <div class="features-grid">

      <!-- Feature 1: Foot Sensors (FSR) -->
      <details class="feature-card" data-index="0">
        <summary class="feature-summary">
          <img src="../images/wavguard/footsensor.png" alt="foot sensors thumbnail" class="feature-thumb">
          <div class="feature-meta">
            <div class="feature-title">Foot Sensors (FSR)</div>
            <div class="feature-excerpt">
              Embedded pressure sensors measure how weight is distributed across the board.
            </div>
          </div>
        </summary>

        <div class="feature-body" data-full="../images/wavguard/footwalkthrough.png">
          <img src="../images/wavguard/footwalkthrough.png" alt="FSR layout detail" class="feature-fullimg">
          <div class="feature-text">
            <p>
              WavGuard uses force-sensitive resistors (FSRs) embedded beneath the rider’s feet to measure how pressure is distributed across the wakeboard. Instead of relying on absolute force values, which vary widely between riders, the system evaluates <strong>relative pressure ratios</strong> between sensor regions. This allows the system to scale across different rider weights, stances, and skill levels without recalibration.
            </p>

            <p>The board is divided into multiple pressure zones that capture meaningful balance information:</p>

            <ul>
              <li>Toes vs. heels (forward/backward balance)</li>
              <li>Left vs. right side (lateral balance)</li>
              <li>Diagonal corners (rotational imbalance)</li>
            </ul>

            <p>
              At each timestep, raw analog FSR readings are normalized into percentage-based ratios representing how total rider weight is distributed across the board. For example, instead of measuring force in newtons, the system determines whether 60% of pressure is on the toes and 40% on the heels.
            </p>

            <p>
              This ratio-based approach ensures that feedback reflects <em>how</em> a rider is balancing, not <em>how hard</em> they are pushing. These normalized pressure ratios are then passed to the Code Logic layer, where they are compared against expected values derived from board orientation.
            </p>
          </div>
        </div>
      </details>

      <!-- Feature 2: IMU Sensor -->
      <details class="feature-card" data-index="1">
        <summary class="feature-summary">
          <img src="../images/wavguard/imu.png" alt="IMU sensor thumbnail" class="feature-thumb">
          <div class="feature-meta">
            <div class="feature-title">IMU Sensor</div>
            <div class="feature-excerpt">
              Measures board tilt and orientation to interpret rider intent.
            </div>
          </div>
        </summary>

        <div class="feature-body" data-full="../images/wavguard/imu.png">
          <img src="../images/wavguard/features/imu.png" alt="IMU orientation detail" class="feature-fullimg">
          <div class="feature-text">
            <p>
              WavGuard uses an inertial measurement unit (IMU) to track the board’s orientation in real time. Specifically, roll and pitch angles are monitored to determine how the board is tilted relative to the water. This information provides critical context for interpreting pressure data from the FSRs.
            </p>

            <p>
              Raw IMU data is filtered to reduce noise caused by wakes, vibration, and transient disturbances. Short-duration spikes are suppressed so that feedback reflects sustained rider behavior rather than momentary water conditions.
            </p>

            <p>The system defines three tilt-based training zones:</p>

            <ul>
              <li><strong>0–8° (Balance Mode):</strong> The board is considered relatively flat. The system checks for even pressure distribution across all FSR regions and reinforces basic stance awareness.</li>
              <li><strong>8–20° (Edge Commitment Mode):</strong> The rider is intentionally edging. In this range, pressure is expected to shift in proportion to the tilt angle, and feedback teaches riders how to commit weight correctly.</li>
              <li><strong>&gt;22° (Safety Warning Mode):</strong> The board is approaching a loss-of-control condition. Large red warnings prioritize rider safety rather than correction.</li>
            </ul>

            <p>
              By using tilt thresholds, the IMU prevents the system from penalizing riders for intentional maneuvers while still identifying unintentional imbalance. IMU data is passed to the Code Logic layer to determine the expected pressure distribution for a given board angle.
            </p>
          </div>
        </div>
      </details>

      <!-- Feature 3: Code Logic -->
      <details class="feature-card" data-index="2">
        <summary class="feature-summary">
          <img src="../images/wavguard/pcbscematic.png" alt="code logic thumbnail" class="feature-thumb">
          <div class="feature-meta">
            <div class="feature-title">Code Logic</div>
            <div class="feature-excerpt">
              Integrates sensor data to determine when and how feedback is shown.
            </div>
          </div>
        </summary>

        <div class="feature-body" data-full="../images/wavguard/pcb.png">
          <img src="../images/wavguard/pcb.png" alt="control logic schematic" class="feature-fullimg">
          <div class="feature-text">
            <p>
              The Code Logic layer acts as the central decision-making system of WavGuard. It combines normalized pressure ratios from the FSRs with orientation data from the IMU to determine when feedback is necessary and what form it should take.
            </p>

            <p>
              For each timestep, the system calculates an <strong>expected pressure ratio</strong> based on board tilt using linear interpolation. For example:
            </p>

            <ul>
              <li>At 0° tilt, expected pressure is evenly distributed (≈50% toes / 50% heels).</li>
              <li>At 15° toe-side tilt, the system expects ~70% of pressure on the toes.</li>
              <li>At higher tilt angles, expected ratios shift accordingly.</li>
            </ul>

            <p>
              Actual pressure ratios from the FSRs are compared against these expected values. If the mismatch exceeds a predefined tolerance, visual feedback is generated. This prevents constant feedback during minor fluctuations and focuses attention only on meaningful errors.
            </p>

            <p>LED feedback follows three clear rules:</p>
            <ul>
              <li><strong>Blue:</strong> Not enough pressure in a region</li>
              <li><strong>Red:</strong> Too much pressure in a region</li>
              <li><strong>Green:</strong> Appears only when pressure distribution and board orientation are in equilibrium</li>
            </ul>

            <p>
              Balanced regions remain unlit to minimize distraction. Green is not intended as a constant target; rather, it indicates moments of equilibrium. The system is designed as <strong>guidance</strong>, recognizing that certain riding maneuvers naturally require imbalance.
            </p>

            <p>
              To ensure stability and usability, pressure data is debounced, IMU signals are filtered, and feedback updates are rate-limited. Together, these design choices create a responsive yet non-intrusive training system that accelerates learning without overwhelming the rider.
            </p>
          </div>
        </div>
      </details>

      <!-- Feature 4: Waterproofing -->
      <details class="feature-card" data-index="3">
        <summary class="feature-summary">
          <img src="../images/wavguard/watertest.jpg" alt="waterproofing thumbnail" class="feature-thumb">
          <div class="feature-meta">
            <div class="feature-title">Waterproofing</div>
            <div class="feature-excerpt">IP67-rated enclosures and sealed cable glands at all penetrations.</div>
          </div>
        </summary>

        <div class="feature-body" data-full="../images/wavguard/watertestvid.mp4">
          <!-- show video in modal if data-full points to a video; poster provided in feature demo -->
          <video class="feature-fullimg" controls preload="metadata" poster="../images/wavguard/watertest.jpg" playsinline>
            <source src="../images/wavguard/watertestvid.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>

          <div class="feature-text">
            <p>
                RTV silicone and marine-grade sealant are used to attach the LEDs, seal joints, and waterproof the wiring entry points.            </p>
            <ul>
              <li>Gasketed electronics box</li>
              <li>Marine-grade connectors</li>
            </ul>
          </div>
        </div>
      </details>

      <!-- Feature 5: Electronics box -->
      <details class="feature-card" data-index="4">
        <summary class="feature-summary">
          <img src="../images/wavguard/electronicsbox.png" alt="electronics box thumbnail" class="feature-thumb">
          <div class="feature-meta">
            <div class="feature-title">Electronics box</div>
            <div class="feature-excerpt">Modular, serviceable enclosure with quick-access fastener and internal mounting plane.</div>
          </div>
        </summary>

        <div class="feature-body" data-full="../images/wavguard/features/electronicsbox.png">
          <img src="../images/wavguard/electronicsbox.png" alt="electronics box detail" class="feature-fullimg">
          <div class="feature-text">
            <p>
              An IMU is placed in the center electronics box to measure board tilt and angle.
            </p>

            <p>
              An IP65-rated waterproof ABS enclosure with an O-ring seal houses the ESP32, IMU, FSR circuitry, and LED resistors. The enclosure is mounted with threaded inserts for secure attachment and easy service access.
            </p>

            <ul>
              <li>Removable and rechargeable battery</li>
              <li>Exterior on/off button</li>
              <li>Cushioned mounting (neoprene) to isolate shocks and prevent collisions</li>
            </ul>
          </div>
        </div>
      </details>

        <!-- Feature 6: Wire and LED Routing -->
      <details class="feature-card" data-index="5">
        <summary class="feature-summary">
          <img src="../images/wavguard/embed.png" alt="embedded wiring thumbnail" class="feature-thumb">
          <div class="feature-meta">
            <div class="feature-title">Wire and LED Routing</div>
            <div class="feature-excerpt">
              Embedded wiring and edge-mounted LEDs for a finished, waterproof design.
            </div>
          </div>
        </summary>
      
        <div class="feature-body" data-full="../images/wavguard/routing.png">
      
          <!-- Image 1: embedded wiring -->
          <img src="../images/wavguard/embed.png" alt="embedded wiring channels" class="feature-fullimg">
      
          <div class="feature-text">
            <p>
              To create a clean, finished board with no exposed electronics, we used a Dremel
              to machine custom wiring channels directly into the board. These channels route
              power and signal lines beneath the foot pads, connecting the electronics box to
              the foot sensors and LED system while keeping all wiring inaccessible to the rider.
            </p>
      
            <p>
              After routing, the channels were filled with <strong>potting gel and waterproof epoxy</strong>
              to lock the wires in place and provide long-term water resistance. This process
              prevents wire movement under flex and ensures durability in repeated water exposure.
            </p>
      
            <ul>
              <li>Wiring embedded below the board surface</li>
              <li>Potting gel and epoxy for waterproofing and strain relief</li>
              <li>All wiring hidden beneath foot pads for safety and aesthetics</li>
            </ul>
          </div>
      
          <!-- Image 2: LED routing -->
          <img src="../images/wavguard/routing.png" alt="LED routing along board edge" class="feature-fullimg">
      
          <div class="feature-text">
            <p>
              Individually addressable LED strips were mounted along the perimeter of the board
              to provide immediate, intuitive visual feedback. LEDs were placed where they remain
              visible to the rider without interfering with stance or movement.
            </p>
      
            <p>
              Custom 3D-printed corner brackets were designed to secure the LED strips and protect
              both the board edges and electronics from impact during falls or transport.
            </p>
      
            <ul>
              <li>Individually addressable LEDs for zoned feedback</li>
              <li>Edge-mounted placement for high visibility</li>
              <li>3D-printed corner brackets for protection and durability</li>
            </ul>
          </div>
      
        </div>
      </details>


    </div>
  </section>

  <!-- MODAL -->
  <div id="featureModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modal-title">
      <div class="modal-top">
        <div class="modal-title" id="modal-title">Feature title</div>
        <div class="modal-controls">
          <button class="modal-prev" type="button" aria-label="Previous feature">◀ Prev</button>
          <button class="modal-next" type="button" aria-label="Next feature">Next ▶</button>
          <button class="modal-close" type="button" aria-label="Close">✕</button>
        </div>
      </div>
      <div class="modal-body">
        <!-- default image element (may be replaced by video node when needed) -->
        <img src="" alt="" class="modal-img" id="modalImg">
        <div class="modal-text">
          <div id="modalDesc"></div>
          <ul id="modalList"></ul>
        </div>
      </div>
    </div>
  </div>

<script>
  // Collect feature data from the page
  const featureCards = Array.from(document.querySelectorAll('.feature-card'));
  const features = featureCards.map(card => {
    const title = card.querySelector('.feature-title')?.textContent?.trim() || '';
    const excerpt = card.querySelector('.feature-excerpt')?.textContent?.trim() || '';
    const body = card.querySelector('.feature-body');
    let fullSrc = body?.getAttribute('data-full') || '';
    if (!fullSrc) {
      const img = body?.querySelector('img');
      const vid = body?.querySelector('video source');
      if (img) fullSrc = img.src || img.getAttribute('src') || '';
      else if (vid) fullSrc = vid.getAttribute('src') || '';
    }

    const paragraphs = Array.from(body?.querySelectorAll('.feature-text p') || [])
                           .map(p => p.textContent.trim())
                           .filter(t => t.length > 0);

    const listItems = Array.from(body?.querySelectorAll('.feature-text ul li') || [])
                           .map(li => li.textContent.trim())
                           .filter(t => t.length > 0);

    return { title, excerpt, fullSrc, paragraphs, listItems };
  });

  // Modal elements
  const modalOverlay = document.getElementById('featureModal');
  const modalTitle = document.getElementById('modal-title');
  const modalImg = document.getElementById('modalImg');
  const modalDesc = document.getElementById('modalDesc');
  const modalList = document.getElementById('modalList');
  const btnClose = modalOverlay.querySelector('.modal-close');
  const btnPrev = modalOverlay.querySelector('.modal-prev');
  const btnNext = modalOverlay.querySelector('.modal-next');

  let currentIndex = 0;

  function renderMedia(fullSrc, title) {
    const isVideo = /\.(mp4|webm|ogg)$/i.test(fullSrc);
    const modalBody = document.querySelector('.modal-body');

    // remove existing media nodes (img or video)
    const existingImg = modalBody.querySelector('img.modal-img');
    const existingVideo = modalBody.querySelector('video.modal-img');
    if (existingImg) existingImg.remove();
    if (existingVideo) existingVideo.remove();

    if (isVideo) {
      const video = document.createElement('video');
      video.setAttribute('controls', '');
      video.setAttribute('playsinline', '');
      video.className = 'modal-img';
      video.style.width = '100%';
      video.style.height = '100%';
      video.alt = title || '';
      const source = document.createElement('source');
      source.src = fullSrc;
      source.type = 'video/mp4';
      video.appendChild(source);
      modalBody.insertBefore(video, modalBody.querySelector('.modal-text'));
      // try to autoplay muted briefly for user experience (but do not force sound)
      video.muted = true;
      video.play().catch(()=>{/* autoplay may be blocked; that's fine */});
      return;
    } else {
      const img = document.createElement('img');
      img.id = 'modalImg';
      img.className = 'modal-img';
      img.src = fullSrc || '';
      img.alt = title || '';
      modalBody.insertBefore(img, modalBody.querySelector('.modal-text'));
    }
  }

  function openModal(index) {
    if (index < 0 || index >= features.length) return;
    currentIndex = index;
    const f = features[index];

    modalTitle.textContent = f.title || 'Feature';
    renderMedia(f.fullSrc || '', f.title);

    // paragraphs
    modalDesc.innerHTML = '';
    if (f.paragraphs && f.paragraphs.length) {
      f.paragraphs.forEach(text => {
        const p = document.createElement('p');
        p.textContent = text;
        modalDesc.appendChild(p);
      });
    } else {
      modalDesc.textContent = f.excerpt || '';
    }

    // list
    modalList.innerHTML = '';
    if (f.listItems && f.listItems.length) {
      f.listItems.forEach(li => {
        const el = document.createElement('li');
        el.textContent = li;
        modalList.appendChild(el);
      });
    }

    modalOverlay.classList.add('open');
    modalOverlay.setAttribute('aria-hidden', 'false');
    btnClose.focus();
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    modalOverlay.classList.remove('open');
    modalOverlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    // stop/remove any playing video
    const video = document.querySelector('.modal-body video');
    if (video) { video.pause(); video.remove(); }
    // ensure base img exists for next open
    const modalBody = document.querySelector('.modal-body');
    if (!modalBody.querySelector('img.modal-img')) {
      const img = document.createElement('img');
      img.id = 'modalImg';
      img.className = 'modal-img';
      img.src = '';
      img.alt = '';
      modalBody.insertBefore(img, modalBody.querySelector('.modal-text'));
    }
  }

  function showPrev() { openModal((currentIndex - 1 + features.length) % features.length); }
  function showNext() { openModal((currentIndex + 1) % features.length); }

  // Attach click handlers
  featureCards.forEach((card, idx) => {
    const summary = card.querySelector('.feature-summary');
    summary.addEventListener('click', (e) => {
      if (e.target.closest('a')) return; // let links behave normally
      e.preventDefault();
      openModal(idx);
    });
    summary.setAttribute('tabindex','0');
    summary.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModal(idx); }
    });
  });

  // Modal controls
  btnClose.addEventListener('click', closeModal);
  btnPrev.addEventListener('click', (e)=>{ e.stopPropagation(); showPrev(); });
  btnNext.addEventListener('click', (e)=>{ e.stopPropagation(); showNext(); });

  modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

  document.addEventListener('keydown', (e) => {
    if (!modalOverlay.classList.contains('open')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') showPrev();
    if (e.key === 'ArrowRight') showNext();
  });

  // preload images (skip videos)
  features.forEach(f => {
    if (f.fullSrc && !/\.(mp4|webm|ogg)$/i.test(f.fullSrc)) {
      const img = new Image();
      img.src = f.fullSrc;
    }
  });
</script>

</body>
</html>

